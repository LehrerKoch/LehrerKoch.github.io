<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <title>Quadratzahlen Übungsaufgaben</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5K8WYYXDL2"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-5K8WYYXDL2');
  </script>
</head>
<body>
  <h1>Quadratzahlen Übungsaufgaben</h1>

  <details>
    <summary>Settings</summary>
    <form id="settingsForm">

      <div class="form-block">
        <b>Zahlenbereiche:</b><br>

        <button type="button" onclick="toggleRange(1,10)">1–10</button><br>
        <div id="range1_10"></div>

        <button type="button" onclick="toggleRange(11,20)">11–20</button><br>
        <div id="range11_20"></div>

        <button type="button" onclick="toggleRange(21,25)">21–25</button><br>
        <div id="range21_25"></div>
      </div>

      <div class="form-block">
        <b>Optionen:</b><br>
        <input type="checkbox" id="multifactor"> Auch 10-, 100-, 1000-fach<br>
        <input type="checkbox" id="fractional"> Auch Zehntel, Hundertstel, Tausendstel<br>
      </div>

      <div class="form-block">
        <b>Aufgabentyp:</b><br>
        <input type="radio" name="wurzelmode" value="none" checked> Keine Wurzelaufgaben<br>
        <input type="radio" name="wurzelmode" value="both"> Auch Wurzelaufgaben<br>
        <input type="radio" name="wurzelmode" value="only"> Nur Wurzelaufgaben<br>
      </div>

    </form>
  </details>

  <p></p>
  <button onclick="generateSquare()">Neue Aufgabe generieren</button>
  <p><span id="Aufgabe">Klicke auf "Neue Aufgabe generieren"</span></p>
  <p><span id="formula"></span></p>

  <button id="showSolutionBtn" onclick="toggleSolution()" style="display:none;">Lösung anzeigen</button>
  <p><span id="loesung"></span></p>

<script>
function makeCheckboxes(containerId, start, end) {
  const container = document.getElementById(containerId);
  for (let i = start; i <= end; i++) {
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.name = "num";
    cb.value = i;
    container.appendChild(cb);
    container.appendChild(document.createTextNode(" " + i + " "));
  }
}

function getParams() {
  const urlParams = new URLSearchParams(window.location.search);

  return {
    selectedNums: urlParams.has('nums') ? urlParams.get('nums').split(',').map(Number) : [],
    multifactor: urlParams.get('multifactor') === "1",
    fractional: urlParams.get('fractional') === "1",
    wurzelmode: urlParams.has('wurzelmode') ? urlParams.get('wurzelmode') : "none"
  };
}

function updateURLParams() {
  const queryParams = new URLSearchParams();

  // ausgewählte Zahlen
  const selected = [];
  document.querySelectorAll('input[name=num]:checked').forEach(cb => {
    selected.push(cb.value);
  });
  if (selected.length > 0) {
    queryParams.set('nums', selected.join(','));
  }

  // Optionen
  queryParams.set('multifactor', document.getElementById("multifactor").checked ? "1" : "0");
  queryParams.set('fractional', document.getElementById("fractional").checked ? "1" : "0");

  // Wurzelmodus
  const wurzelMode = document.querySelector('input[name="wurzelmode"]:checked').value;
  queryParams.set('wurzelmode', wurzelMode);

  const newURL = window.location.pathname + '?' + queryParams.toString();
  history.replaceState({}, '', newURL);
}


function toggleRange(start, end) {
  const checkboxes = document.querySelectorAll(`input[name=num][value]`);
  let alleTrue = true;
  for (let cb of checkboxes) {
    const v = parseInt(cb.value);
    if (v >= start && v <= end && !cb.checked) {
      alleTrue = false;
      break;
    }
  }
  for (let cb of checkboxes) {
    const v = parseInt(cb.value);
    if (v >= start && v <= end) {
        cb.checked = !alleTrue;
    }
  }
  updateURLParams();
}

function getSelectedNumbers() {
  const baseNums = [];
  document.querySelectorAll('input[name=num]:checked').forEach(cb => {
    baseNums.push(parseInt(cb.value));
  });

  let allNums = [...baseNums];
  const mult = document.getElementById("multifactor").checked;
  const frac = document.getElementById("fractional").checked;

  if (mult) {
    baseNums.forEach(n => {
      allNums.push(n*10, n*100, n*1000);
    });
  }
  if (frac) {
    baseNums.forEach(n => {
      allNums.push(n/10, n/100, n/1000);
    });
  }

  return allNums;
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function roundNumber(x, decimals = 6) {
  return Number.parseFloat(x.toFixed(decimals));
}


let lastN = null; // global speichern

function generateSquare() {
  const nums = getSelectedNumbers();
  if (nums.length === 0) {
    alert("Bitte zuerst Zahlen auswählen!");
    return;
  }

  // Zahl auswählen, aber nicht dieselbe wie beim letzten Mal (wenn möglich)
  let n;
  do {
    n = randomChoice(nums);
  } while (nums.length > 1 && n === lastN);
  lastN = n;

  // Aufgabentyp auslesen
  const wurzelMode = document.querySelector('input[name="wurzelmode"]:checked').value;

  let aufgabe, loesung;
  const squared = roundNumber(n * n, 6); // Ergebnis sauber runden

  if (wurzelMode === "none") {
    aufgabe = n + "^2 = ?";
    loesung = n + "^2 = " + squared;
  } else if (wurzelMode === "only") {
    aufgabe = "\\sqrt{" + squared + "} = ?";
    loesung = "\\sqrt{" + squared + "} = " + n;
  } else if (wurzelMode === "both") {
      if (Math.random() < 0.5) {
        aufgabe = n + "^2 = ?";
        loesung = n + "^2 = " + squared;
  } else {
    aufgabe = "\\sqrt{" + squared + "} = ?";
    loesung = "\\sqrt{" + squared + "} = " + n;
    }
  }

  document.getElementById('Aufgabe').innerHTML = "Berechne:";
  document.getElementById('formula').innerHTML = "$$" + aufgabe + "$$";
  document.getElementById("showSolutionBtn").style.display = "inline-block";
  document.getElementById("loesung").innerHTML = "";
  MathJax.typeset();

  window.currentSolution = "$$" + loesung + "$$";
}


function toggleSolution() {
  const target = document.getElementById("loesung");
  if (!window.currentSolution) return;
  if (target.innerHTML === "") {
    target.innerHTML = window.currentSolution;
    MathJax.typeset();
  } else {
    target.innerHTML = "";
  }
}

document.addEventListener('DOMContentLoaded', () => {
  makeCheckboxes("range1_10", 1, 10);
  makeCheckboxes("range11_20", 11, 20);
  makeCheckboxes("range21_25", 21, 25);

  // Werte aus URL holen
  const params = getParams();

  if (params.selectedNums.length > 0) {
    // Zahlen aus URL anhaken
    params.selectedNums.forEach(num => {
      const cb = document.querySelector(`input[name=num][value="${num}"]`);
      if (cb) cb.checked = true;
    });
  } else {
    // ✅ Standard: 1–10 ankreuzen
    for (let i = 1; i <= 10; i++) {
      const cb = document.querySelector(`input[name=num][value="${i}"]`);
      if (cb) cb.checked = true;
    }
    updateURLParams(); // gleich in URL schreiben
  }

  // Optionen setzen
  document.getElementById("multifactor").checked = params.multifactor;
  document.getElementById("fractional").checked = params.fractional;

  // Wurzelmodus setzen
  const wurzelRadio = document.querySelector(`input[name="wurzelmode"][value="${params.wurzelmode}"]`);
  if (wurzelRadio) wurzelRadio.checked = true;

  // Eventlistener für alle Inputs → URL aktualisieren + neue Aufgabe
  document.querySelectorAll('#settingsForm input').forEach(input => {
    input.addEventListener('change', () => {
      updateURLParams();
      generateSquare();
    });
  });

  // Erste Aufgabe generieren
  generateSquare();
});

</script>

</body>
</html>
